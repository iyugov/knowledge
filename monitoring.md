# Настройка мониторинга

## Описание

Настраивается сервер мониторинга с Zabbix. В качестве веб-сервера используется Apache, в качестве системы управления базами данных - MySQL.

## Требования

* [Настройка MediaWiki](mediawiki-database.md)

## Выполнение

*На сайте <https://www.zabbix.com/download> можно выбрать параметры установки и получить команды для неё.*

*Описываемым параметрам установки соответствует следующая ссылка:
<https://www.zabbix.com/download?zabbix=7.2&os_distribution=ubuntu&os_version=24.04&components=server_frontend_agent&db=mysql&ws=apache>*

1. На сервере "Monitoring" загрузим пакет с источниками пакетов Zabbix, установим источники, удалим файл пакета, а затем установим сами компоненты Zabbix, а также сервер MySQL:

    ```sh
    sudo wget https://repo.zabbix.com/zabbix/7.2/release/ubuntu/pool/main/z/zabbix-release/zabbix-release_latest_7.2+ubuntu24.04_all.deb
    sudo dpkg -i zabbix-release_latest_7.2+ubuntu24.04_all.deb
    rm zabbix-release_latest_7.2+ubuntu24.04_all.deb
    sudo apt update
    sudo apt install zabbix-server-mysql zabbix-frontend-php zabbix-apache-conf zabbix-sql-scripts zabbix-agent mysql-server
    ```

2. Откроем консоль сервера MySQL:

    ```sh
    sudo mysql
    ```

3. Создадим базу данных `zabbix`, пользователя `zabbix` для неё (вместо `PASSWORD` зададим пароль пользователя), установим флаг доверия создаваемым функциям (для импорта конфигурации) и выйдем из консоли:

    ```sql
    CREATE DATABASE zabbix CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;
    CREATE USER 'zabbix'@'localhost' IDENTIFIED BY 'PASSWORD';
    GRANT ALL PRIVILEGES ON zabbix.* TO 'zabbix'@'localhost';
    SET GLOBAL log_bin_trust_function_creators = 1;
    EXIT;
    ```

4. Импортируем конфигурацию базы данных для Zabbix:

    ```sh
    zcat /usr/share/zabbix/sql-scripts/mysql/server.sql.gz | mysql --default-character-set=utf8mb4 -uzabbix -p zabbix
    ```

    Введём пароль для пользователя `zabbix` базы данных.
    Дождёмся окончания импорта.

5. Откроем консоль сервера MySQL:

    ```sh
    sudo mysql
    ```

6. Снимем флаг доверия создаваемым функциям (для импорта конфигурации) и выйдем из консоли:

    ```sql
    SET GLOBAL log_bin_trust_function_creators = 0;
    EXIT;
    ```

7. Откроем файл конфигурации сервера Zabbix:

    ```sh
    sudo vim /etc/zabbix/zabbix_server.conf
    ```

8. В файле раскомментируем строку с параметром `DBPassword` или допишем новую такую строку и в качестве значения параметра укажем пароль для пользователя `zabbix` базы данных (вместо `PASSWORD`):

    ```config
    DBPassword=PASSWORD
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

9. Включим русскую локаль, если она ещё не установлена:

    ```sh
    sudo locale-gen ru_RU.UTF-8
    ```

10. Перезапустим и включим в автоматическую загрузку служб Zabbix и веб-сервера:

    ```sh
    sudo systemctl restart zabbix-server zabbix-agent apache2
    sudo systemctl enable zabbix-server zabbix-agent apache2
    ```

11. Установим правило межсетевого экрана для веб-сервера (HTTP):

    ```sh
    sudo ufw allow http
    ```

12. На роутерах "Router1" и "Router2" настроим перенаправление портов для подключения к веб-серверам через балансировщики по виртуальному адресу из внешней сети по порту 8088:

    ```mikrotik
    ip firewall nat add chain=dstnat in-interface=ether1 protocol=tcp dst-port=8088 action=dst-nat to-addresses=192.168.3.10 to-ports=80
    ```

13. В веб-браузере на хосте, имеющим доступ к хосту "Monitoring", откроем ресурс по соответствующеу адресу и порту в каталоге `/zabbix`.

14. В веб-браузере выберем язык: "Русский ru_RU)". Нажмём кнопку "Далее".

15. Проверим предварительные требования (везде должны стоять отметки "OK"). Нажмём кнопку "Далее".

16. Укажем параметры подключения:
    * тип базы данных - MySQL;
    * хост базы данных - `localhost`;
    * порт базы данных - 0 (по умолчанию);
    * имя базы данных - `zabbix`;
    * хранение учётных данных - в простоим текстовом формате;
    * имя пользователя - `zabbix`;
    * пароль - тот пароль, который был установлен для этого пользователя базы данных.
    Нажмём кнопку "Далее.

17. Зададим имя сервера Zabbix - "Monitoring". Выберем часовой пояс - "(UTC+03:00) Europe/Moscow". Выберем тему оформления по умолчанию - "Голубая". Нажмём кнопку "Далее".

18. Проверим ранее указанные параметры настройки. При необходимости - вернёмся назад (кнопки "Назад") и скорректируем настройки. Нажмём кнопку "Далее".

19. Дождёмся окончания установки. Нажмём кнопку "Финиш".

20. Авторизуемся в Zabbix с помощью имени пользователя "Admin" и пароля "zabbix".

21. Слева в разделе "Настройки пользователя" выберем пункт "Профиль". Нажмём кнопку "Изменить пароль". Введём прежний пароль и зададим новый пароль, указав его дважды. Нажмём кнопку "Обновить". Согласимся на завершение сеанса.

22. Авторизуемся в Zabbix с именем пользователя "Admin" и установленным паролем.

23. В консоли хоста "Monitoring" откроем файл конфигурации сайта веб-сервера:

    ```sh
    sudo vim /etc/apache2/sites-enabled/000-default.conf
    ```

24. В разделе `<VirtualHost *:80>` добавим настройку перенаправления на каталог "Zabbix":

    ```config
    RedirectMatch 301 ^/$ /zabbix/
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

25. Перезапустим службу веб-сервера:

    ```sh
    sudo systemctl restart apache2
    ```

26. В веб-браузере на хосте, имеющим доступ к хосту "Monitoring", откроем ресурс по соответствующеу адресу и порту, не указывая каталог `/zabbix`. Должно произойти перенаправление на `/zabbix`.

27. На хосте "Monitoring" откроем файл конфигурации сервера Zabbix:

    ```sh
    sudo vim /etc/zabbix/zabbix_server.conf
    ```

28. В файле раскомментируем или допишем строки с параметрами программ "ping" и установим им следующие значения:

    ```config
    FpingLocation=/usr/bin/fping
    Fping6Location=/usr/bin/fping6
    ```

    Сохраним изменения, выйдем из редактора (`Esc`, `Shift`+`z`, `Shift`+`z`).

29. Перезапустим сервер и агент Zabbix:

    ```sh
    sudo systemctl restart zabbix-server zabbix-agent
    ```

30. В веб-интерфейсе Zabbix слева в разделе "Сбор данных" выберем пункт "Группы узлов сети".

31. С помощью кнопки справа вверху "Создать группу узлов сети" добавим группу "Doc servers".

32. В разделе "Сбор данных" выберем пункт "Шаблоны".

33. В списке шаблонов найдём "ICMP ping", нажмём на "Элементы данных" для него. Для каждого из трёх элементов, открыв его, добавим в ключ ("Ключ") `[{HOST.IP}]`; таким образом, ключи должны быть такие:
    * `icmpping[{HOST.IP}]`
    * `icmppingloss[{HOST.IP}]`
    * `icmppingsec[{HOST.IP}]`

34. В разделе "Сбор данных" выберем пункт "Узлы сети".

35. С помощью кнопки справа вверху "Создать узел сети" добавим следующие хосты для мониторинга в группе хостов "Doc servers":

    * имя хоста: "balancer1"; отображаемое имя: "Balancer 1";
    * имя хоста: "balancer2"; отображаемое имя: "Balancer 2";
    * имя хоста: "web1"; отображаемое имя: "Web 1";
    * имя хоста: "web2"; отображаемое имя: "Web 2";
    * имя хоста: "db1"; отображаемое имя: "DB 1";
    * имя хоста: "db2"; отображаемое имя: "DB 2";
    * имя хоста: "backup"; отображаемое имя: "Backup".

36. Для каждого из добавленных хостов добавим шаблон "ICMP ping": откроем свойства хоста, начнём вводить "ICMP ping", подтвердим выбор; также добавим интерфейс - агента, укажем IP-адрес и имя соответствующего хоста.

37. Подождём около минуты, затем выберем раздел "Панели". При недоступных серверах должны отображаться соответствующие сообщения.
